<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>File uploader</title>
  </head>
  <body>
    <h1>My file uploader</h1>

    File: <input type="file" id="f" />
    <button id="btnUpload">Read & Upload</button>
    <div id="divOutput"></div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/bluebird@3.7.2/js/browser/bluebird.min.js"></script>
    <script>
      const btnUpload = document.getElementById("btnUpload");
      const divOutput = document.getElementById("divOutput");
      const f = document.getElementById("f");
      console.log("loaded");

      btnUpload.addEventListener("click", () => {
        const fileReader = new FileReader();
        const theFile = f.files[0];

        fileReader.onloadend = async (e) => {
          const CHUNK_SIZE = 1024 * 1024 * 5; // 5mb
          const CHUNK_COUNT = e.target.result.byteLength / CHUNK_SIZE;
          console.log(CHUNK_COUNT)

          const { fileId, fileKey } = await fetch(
            "http://localhost:3000/uploads/init",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                name: theFile.name,
              }),
            }
          ).then((r) => r.json());

          const { parts } = await fetch(
            "http://localhost:3000/uploads/getUrls",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                fileKey: fileKey,
                fileId: fileId,
                parts: Math.ceil(CHUNK_COUNT),
              }),
            }
          ).then((r) => r.json());

          parts.sort((a, b) => a.PartNumber - b.PartNumber);
          const finished = [];

          const fn = async (i) => {
            const chunk = e.target.result.slice(
              i * CHUNK_SIZE,
              i * CHUNK_SIZE + CHUNK_SIZE
            );

            const response = await axios.put(parts[i].signedUrl, chunk, {
              headers: {
                "Content-Type": "",
              },
            });

            const etag = response.headers["etag"]

            finished.push({
              PartNumber: parts[i].PartNumber,
              ETag: etag.replaceAll('"', ""),
            });
          }
          const n = []

          for (let i = 0; i < CHUNK_COUNT; i++) {
            n.push(i);
          }

          await Promise.map(n, fn, { concurrency: 15 })

          
          const response = await axios.post("http://localhost:3000/uploads/finish", {
            fileId: fileId,
            fileKey: fileKey,
            parts: finished,
          });

          console.log(response);
        };

        fileReader.readAsArrayBuffer(theFile);
      });
    </script>
  </body>
</html>
